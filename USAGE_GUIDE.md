# 病理图像标注系统 - 详细使用指南

## 目录
1. [系统访问](#系统访问)
2. [基础操作](#基础操作)
3. [高级功能](#高级功能)
4. [常见场景](#常见场景)
5. [数据管理](#数据管理)
6. [故障排除](#故障排除)
7. [系统局限性](#系统局限性)

---

## 系统访问

### 在线访问
- **沙箱环境**: https://3000-itlgpys4bhtsrug4lqi7i-02b9cc79.sandbox.novita.ai
- **生产环境**: (部署后提供)

### 本地部署
```bash
cd /home/user/webapp
npm run build
pm2 start ecosystem.config.cjs
# 访问: http://localhost:3000
```

---

## 基础操作

### 1. 创建项目

**步骤**:
1. 点击右上角 **"新建项目"** 按钮
2. 在弹出框中输入项目名称，例如: `肺癌组织分析`
3. 输入项目描述（可选），例如: `用于肺癌病理切片的细胞核识别和分类`
4. 项目创建后会自动出现在左侧项目列表中

**示例项目**:
系统已预设两个示例项目：
- 肺癌组织分析
- 乳腺癌研究

### 2. 添加图像

目前需要通过API添加图像元数据。未来版本会添加UI上传功能。

**方法1: 使用curl命令**
```bash
curl -X POST http://localhost:3000/api/projects/1/images \
  -H "Content-Type: application/json" \
  -d '{
    "filename": "lung_cancer_slide_001.jpg",
    "original_name": "肺癌切片-患者A-01.jpg",
    "width": 2048,
    "height": 1536,
    "file_size": 524288
  }'
```

**方法2: 使用JavaScript (浏览器控制台)**
```javascript
await axios.post('/api/projects/1/images', {
  filename: 'breast_cancer_001.jpg',
  original_name: '乳腺癌切片-HE染色.jpg',
  width: 1920,
  height: 1080,
  file_size: 480000
});
```

### 3. 选择项目和图像

**选择项目**:
1. 在左侧 **"项目列表"** 中点击任意项目
2. 选中的项目会高亮显示（蓝色背景）
3. 该项目下的所有图像会显示在 **"图像列表"** 中

**选择图像**:
1. 在 **"图像列表"** 中点击任意图像
2. 图像会加载到中间的画布区域
3. 选中的图像会高亮显示（绿色背景）
4. 该图像的所有标注会显示在右侧 **"标注列表"** 中

### 4. 标注工具使用

#### 4.1 点标注 (Point Annotation)

**用途**: 快速标记单个细胞的中心位置

**步骤**:
1. 点击工具栏中的 **圆圈图标** (🔵)
2. 在 **"标签"** 下拉菜单中选择细胞类型
3. 在图像上单击，即可创建一个点标注
4. 标注会立即保存并显示在标注列表中

**适用场景**:
- 快速细胞计数
- 大范围细胞统计
- 初步筛查

#### 4.2 多边形标注 (Polygon Annotation)

**用途**: 精确勾画细胞的轮廓和边界

**步骤**:
1. 点击工具栏中的 **多边形图标** (🟣)
2. 选择细胞类型标签
3. 在细胞边缘连续点击，绘制多边形顶点
4. 点击起点附近（10像素内）或双击完成多边形
5. 系统会自动计算面积并保存

**技巧**:
- 尽量贴近细胞边界点击
- 复杂形状可以增加顶点数量
- 按顺时针或逆时针方向点击
- 保持手稳，避免抖动

**适用场景**:
- 精确细胞形态分析
- 面积测量
- 细胞大小对比

#### 4.3 平移工具 (Pan)

**用途**: 移动查看不同区域

**操作**:
1. 点击 **手掌图标** (✋) 或默认激活
2. 按住鼠标左键拖拽移动图像
3. 释放鼠标完成平移

**快捷方式**:
- 任何工具下按住空格键临时切换到平移模式

#### 4.4 删除工具 (Delete)

**用途**: 删除错误的标注

**操作**:
1. 点击 **垃圾桶图标** (🗑️)
2. 点击要删除的标注
3. 标注会立即删除并更新统计

**注意**:
- 删除操作不可撤销
- 点标注需要精确点击
- 多边形标注点击内部任意位置即可删除

### 5. 视图控制

#### 5.1 缩放功能

**方法1: 工具栏按钮**
- 🔍+ : 放大
- 🔍- : 缩小

**方法2: 鼠标滚轮**
- 向上滚动: 放大
- 向下滚动: 缩小
- 滚轮缩放会以鼠标位置为中心

**方法3: 快捷键** (未来版本)
- `+` / `=` : 放大
- `-` / `_` : 缩小

#### 5.2 重置视图

点击 **⛶ 图标** 恢复到默认视图:
- 缩放比例重置为100%
- 图像居中显示
- 清除所有平移偏移

### 6. 查看标注信息

**标注列表** (右侧面板):
- 显示当前图像的所有标注
- 颜色编码对应细胞类型
- 显示标注类型和面积（多边形）
- 实时更新数量

**统计信息** (右侧下方):
- **总计**: 所有标注数量
- **分类统计**: 按细胞类型统计
- 颜色条与标签对应

---

## 高级功能

### 1. 批量导入标注

如果你有AI模型生成的预测结果，可以批量导入。

**API调用示例**:
```bash
curl -X POST http://localhost:3000/api/images/1/annotations/batch \
  -H "Content-Type: application/json" \
  -d '{
    "annotations": [
      {
        "annotation_type": "point",
        "label": "lymphocyte",
        "coordinates": [{"x": 150, "y": 200}],
        "confidence": 0.95,
        "created_by": "model"
      },
      {
        "annotation_type": "polygon",
        "label": "tumor",
        "coordinates": [
          {"x": 300, "y": 400},
          {"x": 320, "y": 390},
          {"x": 330, "y": 410},
          {"x": 310, "y": 420}
        ],
        "area": 450.5,
        "confidence": 0.88,
        "created_by": "model"
      }
    ]
  }'
```

**Python脚本示例**:
```python
import requests
import json

# AI模型预测结果
predictions = [
    {
        "annotation_type": "point",
        "label": "lymphocyte",
        "coordinates": [{"x": 150, "y": 200}],
        "confidence": 0.95,
        "created_by": "model"
    },
    # ... 更多预测
]

# 批量上传
response = requests.post(
    'http://localhost:3000/api/images/1/annotations/batch',
    json={"annotations": predictions}
)

print(f"Imported {len(response.json()['data'])} annotations")
```

### 2. 数据导出

**导出当前图像的所有标注**:
1. 确保已选择图像
2. 点击右侧 **"导出数据"** 按钮
3. 浏览器会自动下载JSON文件

**导出文件格式**:
```json
{
  "image": {
    "id": 1,
    "filename": "sample.jpg",
    "width": 2048,
    "height": 1536
  },
  "annotations": [
    {
      "id": 1,
      "annotation_type": "polygon",
      "label": "lymphocyte",
      "coordinates": "[{\"x\":150,\"y\":200}...]",
      "area": 250.5,
      "confidence": 0.95,
      "created_by": "user",
      "created_at": "2025-11-25 12:00:00"
    }
  ],
  "export_date": "2025-11-25T12:00:00.000Z"
}
```

### 3. 数据库直接查询

**查看所有项目**:
```bash
cd /home/user/webapp
npm run db:console:local
# 输入: SELECT * FROM projects;
```

**查看标注统计**:
```sql
SELECT label, COUNT(*) as count, AVG(area) as avg_area
FROM annotations
WHERE image_id = 1
GROUP BY label;
```

**删除指定项目的所有数据**:
```sql
DELETE FROM projects WHERE id = 1;
-- 由于外键约束，会自动删除关联的图像和标注
```

---

## 常见场景

### 场景1: 淋巴细胞计数

**任务**: 统计病理切片中的淋巴细胞数量

**步骤**:
1. 创建项目 "淋巴细胞计数研究"
2. 上传HE染色切片图像
3. 选择 **点标注工具**
4. 标签选择 **"淋巴细胞"**
5. 依次点击所有淋巴细胞位置
6. 查看右侧统计: 淋巴细胞数量自动更新
7. 导出数据进行分析

**预期结果**: 快速获得淋巴细胞总数和分布

### 场景2: 肿瘤细胞形态分析

**任务**: 测量肿瘤细胞的大小和形状

**步骤**:
1. 选择肿瘤组织图像
2. 选择 **多边形标注工具**
3. 标签选择 **"肿瘤细胞"**
4. 精确勾画每个肿瘤细胞轮廓
5. 系统自动计算面积
6. 导出数据，分析面积分布

**预期结果**: 获得每个肿瘤细胞的精确面积数据

### 场景3: 多类型细胞分类

**任务**: 识别和分类多种细胞类型

**步骤**:
1. 打开混合细胞类型的图像
2. 使用点或多边形工具
3. 对每个细胞：
   - 选择对应的标签
   - 进行标注
4. 查看统计信息中的分类分布
5. 导出完整标注数据

**预期结果**: 获得各类细胞的数量和比例

### 场景4: AI模型结果验证

**任务**: 验证和修正AI模型的预测结果

**步骤**:
1. 通过API批量导入模型预测
2. 在界面中查看所有标注
3. 使用 **删除工具** 删除错误标注
4. 使用标注工具补充遗漏的细胞
5. 重新导出标注作为训练数据

**预期结果**: 获得人工验证后的高质量标注数据

---

## 数据管理

### 数据库备份

**备份本地数据库**:
```bash
cd /home/user/webapp
tar -czf db_backup_$(date +%Y%m%d).tar.gz .wrangler/state/v3/d1
```

**恢复备份**:
```bash
tar -xzf db_backup_20251125.tar.gz -C /home/user/webapp/
```

### 重置数据库

**警告**: 此操作会删除所有数据！

```bash
cd /home/user/webapp
npm run db:reset
```

### 数据迁移

**从本地迁移到生产环境**:
```bash
# 1. 导出本地数据
sqlite3 .wrangler/state/v3/d1/pathology-db-production.sqlite .dump > local_data.sql

# 2. 上传到生产数据库
wrangler d1 execute pathology-db-production --file=local_data.sql --remote
```

---

## 故障排除

### 问题1: 无法创建标注

**症状**: 点击图像后没有反应

**可能原因**:
- 未选择图像
- 工具未正确激活
- 浏览器控制台有错误

**解决方案**:
1. 确认已选择图像（绿色高亮）
2. 重新点击工具按钮
3. 按F12查看控制台错误
4. 刷新页面重试

### 问题2: 图像不显示

**症状**: 画布区域显示占位符

**可能原因**:
- 图像数据未上传
- 数据库连接问题

**解决方案**:
1. 检查数据库是否有图像记录
2. 重启应用: `pm2 restart pathology-annotation`
3. 查看PM2日志: `pm2 logs --nostream`

### 问题3: 标注消失

**症状**: 创建的标注看不见

**可能原因**:
- 视图缩放或平移过度
- 标注在图像可见区域外

**解决方案**:
1. 点击重置视图按钮 (⛶)
2. 检查标注列表，确认标注已创建
3. 使用平移工具查找标注位置

### 问题4: 性能问题

**症状**: 操作延迟，画面卡顿

**可能原因**:
- 标注数量过多
- 图像尺寸过大
- 浏览器内存不足

**解决方案**:
1. 刷新页面释放内存
2. 减少单张图像上的标注数量
3. 使用较小尺寸的图像
4. 关闭其他浏览器标签页

---

## 系统局限性

### 图像处理限制

1. **不支持WSI大图**
   - 原因: 无图像金字塔处理
   - 影响: 无法处理病理全片扫描图像
   - 替代方案: 使用QuPath或原nuclei.io

2. **无自动分割**
   - 原因: 未集成Stardist等算法
   - 影响: 需要完全手动标注
   - 替代方案: 使用第三方AI服务API

3. **图像存储限制**
   - 当前: 使用示例图像
   - 生产: 需配置Cloudflare R2
   - 单文件限制: 建议 < 10MB

### 功能限制

1. **无协作功能**
   - 影响: 单用户标注
   - 无法多人同时工作
   - 无标注冲突解决

2. **无历史记录**
   - 标注删除后无法恢复
   - 无修改历史追踪
   - 建议定期导出备份

3. **有限的标注类型**
   - 仅支持点和多边形
   - 无圆形、矩形、画笔等
   - 无标注组合功能

### 扩展建议

如需更多功能，可以：

1. **集成AI服务**
   - OpenAI Vision API
   - Google Cloud Vision
   - 自建深度学习模型

2. **添加文件上传**
   - 配置R2存储
   - 实现前端上传UI
   - 支持批量上传

3. **增强可视化**
   - 热力图显示
   - 统计图表
   - 3D可视化

4. **改进交互**
   - 键盘快捷键
   - 撤销/重做功能
   - 批量编辑工具

---

## 联系支持

- **项目仓库**: (GitHub链接)
- **问题反馈**: 通过GitHub Issues
- **功能建议**: 欢迎提交Pull Request

---

**最后更新**: 2025-11-25  
**版本**: 1.0.0
